<div class="wrap div_layer" id="searchClubberWrap">
  <style>
    #searchClubberWrap {
      height: 100%;
      position: relative;
      overflow-y: auto;
    }
  </style>
  <script type="text/javascript">
    var isLoading = false;
    var maxClubberCnt = 100; //클러버 최대 노출 개수

    $(document).ready(function () {
      getClubberList();

      $('#searchClubberWrap').on('scroll', function () {
        if (isLoading) return;
        if ($('#searchTopClubberForm #nowPage').val() >= $('#searchTopClubberForm #lastPage').val() || $('#clubberList').children().length >= maxClubberCnt) return;
        if ($(this).scrollTop() + $(this).innerHeight() >= $(this).prop('scrollHeight')) {
          $('#searchTopClubberForm #nowPage').val(Number($('#searchTopClubberForm #nowPage').val()) + 1);
          //getClubberList();
          isLoading = true;
          getClubberList().done(function () {
            isLoading = false;
          });
        }
      });
    });

    //검색창에서 엔터 키 입력 시
    $('#searchTopClubberForm #searchWord').keydown(function (e) {
      if (e.keyCode == '13') {
        $(this).blur();
        clubberSearch();
      }
    });

    //닫기
    function searchBack() {
      $('body').find('.wrap').last().remove();
      $('body').find('.wrap').last().show();

      //랭크 퍼포머랭킹 다시조회
      if (typeof getTopClubberList == 'function') {
        getTopClubberList();
      }
    }

    //검색 버튼 클릭 시
    function clubberSearch() {
      $('#searchTopClubberForm #nowPage').val('1');
      $('#searchTopClubberForm #lastPage').val('1');
      $('#clubberList').empty();

      getClubberList();
    }

    //클러버 가져오기
    function getClubberList() {
      var dfd = $.Deferred();

      var param = $('#searchTopClubberForm').serialize() + '&memberGrdCd=PERFORMER';

      get('/api/challenge/topClubberList', param).done(function (result) {
        var list = result.data.list;
        var html = '';
        var checked = '';
        var ranking = '';
        var badge = '';
        if (list.length > 0) {
          for (var i = 0; i < list.length; i++) {
            switch (list[i].ranking) {
              case 1:
                ranking = 'first';
                badge = 'no_1';
                break;
              case 2:
                ranking = 'second';
                badge = 'no_2';
                break;
              case 3:
                ranking = 'third';
                badge = 'no_3';
                break;
              default:
                ranking = '';
                badge = '';
            }
            var followDisabled = '';
            if (list[i].myFollowYn == 'Y') {
              checked = '';
            } else if (list[i].myFollowYn == 'N') {
              checked = 'checked';
            } else {
              followDisabled = 'style="display:none;"';
            }
            html += '<div class="performer_list ranking ' + ranking + '">';
            html += '	<a href="javascript:viewUserProfile(\'' + list[i].memberNo + '\');">';
            html += '		<div class="performer" style="background-image: url(' + list[i].profileImgUrl + '), url(/to-be/rsc/front/images/common/ico_mypage.png);">';
            html += '			<i class="badge ' + badge + '">' + list[i].ranking + '</i>';
            html += '		</div>';
            html += '	</a>';
            html += '	<div class="id">';
            html += '		<a href="javascript:viewUserProfile(\'' + list[i].memberNo + '\');">';
            html += '			<p>@' + list[i].memberId + '</p>';
            html += '			<span>' + list[i].winCnt + ' 회우승</span>';
            html += '		</a>';
            html += '	</div>';
            html += '	<div class="follow_toggle" ' + followDisabled + '>';
            html += '		<input type="checkbox" id="clbFollow_' + list[i].memberNo + '" ' + checked + ' data-member-no="' + list[i].memberNo + '" value="' + list[i].myFollowYn + '">';
            html += '		<label for="clbFollow_' + list[i].memberNo + '"><span></span></label>';
            html += '	</div>';
            html += '</div >';
          }
        } else {
        }
        $('#clubberList').append(html);
        $('#searchTopClubberForm #lastPage').val(result.data.lastPage);
        dfd.resolve();
      });
      return dfd.promise();
    }

    //팔로우  toggle
    $(document)
      .off('click', '#searchClubberWrap #clubberList input[type=checkbox][id^=clbFollow_]')
      .on('click', '#searchClubberWrap #clubberList input[type=checkbox][id^=clbFollow_]', function (e) {
        var memberNo = $(this).data('memberNo');
        var followYn = $(this).val();
        var $this = $('#searchClubberWrap #clubberList #clbFollow_' + memberNo);

        getAccessToken().done(function (result) {
          if (result == null || result == '') {
            $this.prop('checked', !$this.is(':checked'));
            openLoginPage();
            /* 	   	 				$this.prop("checked", !$this.is(":checked"));
              layerAlert("로그인이 필요한 서비스입니다.")
              .done(openLoginPage); */
          } else {
            if (followYn == 'Y') {
              del('/api/followCancel/' + memberNo, null, null)
                .done(function (result) {
                  $this.val('N');
                })
                .fail(function (result) {
                  $this.prop('checked', !$this.is(':checked'));
                });
            } else {
              post('/api/follow/' + memberNo, null, null)
                .done(function (result) {
                  $this.val('Y');
                })
                .fail(function (result) {
                  $this.prop('checked', !$this.is(':checked'));
                });
            }
          }
        });
      });

    // 로그인 창이 닫혔을때
    /* 	   	 	function afterCloseLoginPage() {
            getAccessToken()
          .done(function(result) {
            if(result == null || result == "") {
            } else {
              //로그인했으면 목록 다시 조회
              clubberSearch();
            }
          }); 	
        } */

    //searchWord 입력 시 clear button 노출
    $(document)
      .off('propertychange change keyup paste input', '#searchTopClubberForm #searchWord')
      .on('propertychange change keyup paste input', '#searchTopClubberForm #searchWord', function () {
        if ($(this).val().length > 0) {
          $('#searchTopClubberForm .btn_clear').show();
        } else {
          $('#searchTopClubberForm .btn_clear').hide();
        }
      });

    $(document)
      .off('click', '#searchTopClubberForm .btn_clear')
      .on('click', '#searchTopClubberForm .btn_clear', function () {
        $('#searchTopClubberForm #searchWord').trigger('change');
      });
  </script>
  <!-- header -->
  <header>
    <button type="button" class="btn_go_prev" onclick="searchBack()">이전으로</button>
    <h1>퍼포머 랭킹</h1>
  </header>
  <!--// header -->

  <!-- contents -->
  <div class="contents">
    <form id="searchTopClubberForm" onsubmit="return false">
      <input type="hidden" id="topClobber" name="topClobber" value="N" />
      <input type="hidden" id="rowsPerPage" name="rowsPerPage" value="20" />
      <input type="hidden" id="nowPage" name="nowPage" value="1" />
      <input type="hidden" id="lastPage" name="lastPage" value="0" />
      <input type="hidden" id="searchType" name="searchType" value="memberId" />
      <!-- <input type="hidden" id="searchWord" name="searchWord" value=""> -->
      <input type="hidden" id="sortField" name="sortField" value="" />
      <input type="hidden" id="sortWord" name="sortWord" value="" />
      <div class="search_form">
        <div class="input_wrap">
          <input type="search" class="clear" id="searchWord" name="searchWord" value="" placeholder="퍼포머 검색..." maxlength="30" />
          <button class="btn_clear" onclick="clearInput(this)" style="display: none"></button>
        </div>
        <button type="button" class="btn_go_search" onclick="clubberSearch()">검색</button>
      </div>
    </form>
    <div class="all_ranking" id="clubberList"></div>
  </div>
  <!--// contents -->
</div>
