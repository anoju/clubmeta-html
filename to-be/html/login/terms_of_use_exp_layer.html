<div class="wrap divTermsOfUseExp div_layer" id="divTermsOfUseExp">
  <script type="text/javascript">
    var memberNo = '<%= request.getParameter("memberNo") %>';
    $(document).ready(function () {
      // 뒤로가기 버튼 이벤트 세팅
      $('#divTermsOfUseExp .btn_go_prev').on('click', function () {
        layerConfirm('약관에 재동의 하지 않을 경우<br>로그인이 제한 됩니다.')
          .done(function () {
            // 토큰 제거
            fn_removeToken()
              .done(function () {})
              .always(function () {
                // 토큰 제거 성공/실패 상관없이 창닫기
                if (typeof afterCloseExpTermsAgree == 'function') {
                  afterCloseExpTermsAgree(false);
                }
                // 현재 창 닫기
                $('#divTermsOfUseExp').remove();
              });
          })
          .fail(function () {
            // 취소 버튼
          });
      });

      // 약관 목록 조회 및 화면 세팅
      get('/api/terms/TERMS10/list', 'memberNo=' + memberNo + '&reqYn=Y').done(function (result) {
        for (var i = 0; i < result.data.list.length; i++) {
          var idx = i + 1;

          var data = result.data.list[i];
          var div = $('#divTermsOfUseExp #div_agree_' + idx);

          // 화면에는 3개만 표시되는데 그 이상인 경우.
          if (div.length == 0) {
            var clone = $('#divTermsOfUseExp #div_agree_0').clone();
            clone.attr('id', clone.attr('id').replace('_0', '_' + idx));
            clone.find('[id$=_0]').each(function () {
              $(this).attr(
                'id',
                $(this)
                  .attr('id')
                  .replace('_0', '_' + idx)
              );
            });
            clone.find('[for$=_0]').each(function () {
              $(this).attr(
                'for',
                $(this)
                  .attr('for')
                  .replace('_0', '_' + idx)
              );
            });

            clone.show();
            $('#divTermsOfUseExp .agree_check_area').append(clone);

            div = $('#divTermsOfUseExp #div_agree_' + idx);
          }

          div.find('#em_agreeTitle_' + idx).html(data.termsDivNm);
          div.find('#em_agreeReqYn_' + idx).html(data.reqYn == 'Y' ? '(필수)' : '(선택)');
          div.find('#div_agreeCont_' + idx).load(data.termsFilePathUrl);

          div.find('#agree_' + idx).data('reqYn', data.reqYn);

          if (data.agreeYn == 'Y') {
            div.find('#agree_' + idx).prop('checked', true);
          }

          $('#divTermsOfUseExp #expAgreeForm').append("<input type='hidden' name='termsNo' value='" + data.termsNo + "' />");
        }
        if (result.data.list.length < 3) {
          $('#divTermsOfUseExp .agree_check_area .agree_box').each(function () {
            var idx = $(this).attr('id').replace('div_agree_', '');
            if (idx * 1 > result.data.list.length) {
              $(this).remove();
            }
          });
        }
      });

      // 전체 선택 / 해제
      $('#divTermsOfUseExp #agree_all')
        .off('click')
        .on('click', function () {
          if ($(this).prop('checked')) {
            $('#divTermsOfUseExp input[type=checkbox]').prop('checked', true);
          } else {
            $('#divTermsOfUseExp input[type=checkbox]').prop('checked', false);
          }
        });
      // 체크박스 1개라도 해제되면 전체선택체크박스는 해제
      $('#divTermsOfUseExp input[type=checkbox]')
        .off('change')
        .on('change', function () {
          if ($(this).attr('id') != 'agree_all' && !$(this).prop('checked')) {
            $('#divTermsOfUseExp #agree_all').prop('checked', false);
          }

          // 필수 체크 확인
          var isOk = true;
          $('#divTermsOfUseExp input[type=checkbox]').each(function () {
            if ($(this).data('reqYn') == 'Y' && $(this).prop('checked') == false) {
              isOk = false;
              return false;
            }
          });
          if (isOk) {
            $('#divTermsOfUseExp .btn_progress').prop('disabled', false);
          } else {
            $('#divTermsOfUseExp .btn_progress').prop('disabled', true);
          }
        });

      // 다음으로
      $('#divTermsOfUseExp .btn_progress')
        .off('click')
        .on('click', function () {
          var isOk = true;

          /*
				// 필수 체크 확인
				$("#divTermsOfUseExp input[type=checkbox]").each(function() {
					if($(this).data("reqYn") == "Y" && $(this).prop("checked") == false) {
						isOk = false;
						var agreeTitle = $(this).closest("div.agree_box").find("[id^=em_agreeTitle_]").html();
						layerAlert("사용 약관에 동의해 주세요.<br>[" + agreeTitle + "]");
						return false;
					}
				});
				*/

          if (isOk) {
            // 체크박스 선택 여부 hidden으로 화면에 세팅
            $('#divTermsOfUseExp input[name=agreeYn]').remove(); // 혹시 모르니 일단 다 지우고
            // 체크박스 루프 돌면서 hidden으로 세팅해주기
            $('#divTermsOfUseExp .agree_check_area .agree_box input[type=checkbox][id^=agree_]').each(function () {
              var checkYn = $(this).prop('checked') ? 'Y' : 'N';
              // 						$("#divTermsOfUseExp").append("<input type='hidden' name='agreeYn' value='" + checkYn + "' />");
              $('#divTermsOfUseExp #expAgreeForm').append("<input type='hidden' name='agreeYn' value='" + checkYn + "' />");
            });

            var body = $('#divTermsOfUseExp #expAgreeForm').serializeObject();
            body.memberNo = memberNo;

            post('/api/terms/agreeInfo', null, body)
              .done(function (result) {
                afterCloseExpTermsAgree(true);
                $('#divTermsOfUseExp').remove();
                /* Alert없이 진행하도록 수정 요청.
						layerAlert("저장 되었습니다.")
						.done(function() {
							afterCloseExpTermsAgree(true);
							$("#divTermsOfUseExp").remove();
						});
						*/
              })
              .fail(function (result) {
                layerAlert(result.respMsg);
              });
          }
        });
    });
  </script>

  <!-- header -->
  <header>
    <button type="button" class="btn_go_prev">이전으로</button>
    <h1>이용약관 재동의</h1>
  </header>
  <!--// header -->

  <!-- contents -->
  <div class="contents">
    <div class="agree_recheck_txt">개인정보 보유기간에 대한 법령기준에 따라 이용약관 및 개인정보 수집에 대한 재동의가 필요합니다.</div>

    <div class="agree_box" id="div_agree_0" style="display: none">
      <input type="checkbox" id="agree_0" name="chk_agreeYn" />
      <label for="agree_0"><span></span><em id="em_agreeTitle_0"></em> <em id="em_agreeReqYn_0"></em></label>
      <div class="agree_txt" id="div_agreeCont_0"></div>
    </div>

    <h2 class="joinus">이용약관</h2>
    <div class="agree_check_area">
      <input type="checkbox" id="agree_all" />
      <label for="agree_all"><span></span>전체 동의</label>

      <div class="agree_box" id="div_agree_1">
        <input type="checkbox" id="agree_1" />
        <label for="agree_1"><span></span><em id="em_agreeTitle_1"></em> <em id="em_agreeReqYn_1"></em></label>

        <div class="agree_txt" id="div_agreeCont_1"></div>
      </div>

      <div class="agree_box" id="div_agree_2">
        <input type="checkbox" id="agree_2" />
        <label for="agree_2"><span></span><em id="em_agreeTitle_2"></em> <em id="em_agreeReqYn_2"></em></label>

        <div class="agree_txt" id="div_agreeCont_2"></div>
      </div>

      <div class="agree_box" id="div_agree_3">
        <input type="checkbox" id="agree_3" />
        <label for="agree_3"><span></span><em id="em_agreeTitle_3"></em> <em id="em_agreeReqYn_3"></em></label>

        <div class="agree_txt" id="div_agreeCont_3"></div>
      </div>
    </div>

    <button type="button" class="btn_progress" disabled="disabled">다음</button>
  </div>
  <!--// contents -->

  <form id="expAgreeForm" style="height: 100%"></form>
</div>
