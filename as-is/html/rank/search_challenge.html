<div class="wrap div_layer" id="searchChallegeWrap">
  <style>
    #searchChallegeWrap {
      height: 100%;
      position: relative;
      overflow-y: auto;
    }
  </style>
  <script type="text/javascript">
    var isLoading = false;
    var maxChallengeCnt = 100; //챌린지 최대 노출 개수
    var maxVideoCnt = 50; //챌린저 비디오 최대 노출 개수
    var CRswiper; //swiper변수

    $(document).ready(function () {
      getChallengeList();

      $('#searchChallegeWrap').on('scroll', function () {
        if (isLoading) return;
        if ($('#searchChallengeForm #nowPage').val() >= $('#searchChallengeForm #lastPage').val() || $('#challengeList').children().length >= maxChallengeCnt) return;
        if ($(this).scrollTop() + $(this).innerHeight() >= $(this).prop('scrollHeight')) {
          $('#searchChallengeForm #nowPage').val(Number($('#searchChallengeForm #nowPage').val()) + 1);
          //getChallengeList();
          isLoading = true;
          getChallengeList().done(function () {
            isLoading = false;
          });
        }
      });
    });

    //검색창에서 엔터 키 입력 시
    $('#searchChallengeForm #searchWord').keydown(function (e) {
      if (e.keyCode == '13') {
        $(this).blur();
        search();
      }
    });

    //닫기
    function searchBack() {
      $('body').find('.wrap').last().remove();
      $('body').find('.wrap').last().show();
    }

    //검색 버튼 클릭 시
    function search() {
      $('#searchChallengeForm #nowPage').val('1');
      $('#searchChallengeForm #lastPage').val('1');
      $('#challengeList').empty();

      getChallengeList();
    }

    //챌린지 리스트 가져오기
    function getChallengeList() {
      var dfd = $.Deferred();

      var param = $('#searchChallengeForm').serialize();
      get('/api/challenge/search', param).done(function (result) {
        var list = result.data.list;
        var html = '';
        var isSwiper = false;
        var chlgStatusHtml = '';
        for (var i = 0; i < list.length; i++) {
          var list2 = list[i].challengervideolist;
          if (list2.length > 0) {
            isSwiper = true;
          } else {
            isSwiper = false;
          }
          switch (list[i].chlgProgStatusCd) {
            case 'C20':
              chlgStatusHtml = "<span class='l_ing'>진행 중</span>";
              break;
            case 'C30':
              chlgStatusHtml = "<span class='l_waiting'>발표 대기</span>";
              break;
            case 'C90':
              chlgStatusHtml = "<span class='l_ended'>종료</span>";
              break;
            default:
              chlgStatusHtml = '';
          }
          var videoLastPage = parseInt((list[i].chlgPtcpVideoCnt - 1) / 10) + 1;
          html += '<div class="challenge_list" id="challenge_' + list[i].chlgNo + '" data-chlg-no="' + list[i].chlgNo + '">';
          html += '	<form id="challengerForm_' + list[i].chlgNo + '">';
          html += '		<input type="hidden" id="rowsPerPage" name="rowsPerPage" value="10">';
          html += '		<input type="hidden" id="nowPage" name="nowPage" value="1">';
          //html += '		<input type="hidden" id="lastPage" name="lastPage" value="2">';
          html += '		<input type="hidden" id="lastPage" name="lastPage" value="' + videoLastPage + '">';
          html += '		<input type="hidden" id="chlgNo" name="chlgNo" value="' + list[i].chlgNo + '">';
          html += '	</form>';
          html += '	<div class="tit_more">';
          html += '		<h2>' + list[i].chlgName + '</h2>';
          html += chlgStatusHtml;
          html += '		<a href="javascript:openChallengeDetail(\'' + list[i].chlgNo + '\');" class="btn_view_more">더 보기</a>';
          html += '	</div>';

          if (list2.length > 0) {
            if (isSwiper) {
              html += '	<div class="ranking_slider" data-chlg-no="' + list[i].chlgNo + '">';
            } else {
              html += '	<div class="">';
            }
            html += '		<div class="swiper-wrapper" id="swiper-wrapper-' + list[i].chlgNo + '">';

            for (var i2 = 0; i2 < list2.length; i2++) {
              var blind = '';
              var clickUseYn = '';
              var memberId = '@' + list2[i2].memberId;
              var divPerformer = '<div class="performer" onclick="viewUserProfile(\'' + list2[i2].regMemberNo + '\');" style="background-image:url(/as-is/rsc/front/images/common/ico_mypage.png);"></div>';
              if (list2[i2].delYn == 'Y' || list2[i2].videoViewYn == 'N') {
                blind = 'blind';
                clickUseYn = 'N';
              }
              if (list2[i2].memberStatusCd == 'M20' || list2[i2].memberStatusCd == 'M99') {
                //memberId = "@"+list2[i2].memberId;
                memberId = list2[i2].memberStatusCd == 'M20' ? '정지회원' : '탈퇴회원';
                divPerformer = '<div class="performer" onclick="javascript:void(0);" style="background-image: url(' + list2[i2].profileImgUrl + '), url(/as-is/rsc/front/images/common/ico_mypage.png);"></div>';
              }
              html += '			<div class="challenger_list swiper-slide">';
              //html += '				<div class="performer" onclick="viewUserProfile(\''+list2[i2].regMemberNo+'\');" style="background-image: url('+list2[i2].profileImgUrl+'), url(/as-is/rsc/front/images/common/ico_mypage.png);"></div>';
              html += divPerformer;
              //html += '				<a href="javascript:playVideo(\''+list2[i2].videoNo+'\');" class="thumb">';
              html += "				<a href=\"javascript:playVideo('rankVideo', '" + list2[i2].videoNo + "', '10', '1', '" + list[i].chlgNo + "', null, null, '" + clickUseYn + '\');" class="thumb ' + blind + '">';
              html += '					<img src="' + list2[i2].videoThumbUrl + '" alt="">';
              html += '				</a>';
              html += '				<div class="id">';
              html += '					<p onclick="viewUserProfile(\'' + list2[i2].regMemberNo + '\');">' + memberId + '</p>';
              html += '					<div class="point_area">';
              html += '						<span><i class="ico_shoe"></i>' + list2[i2].votingCnt + ' 표</span>';
              html += '						<span><i class="ico_ai"></i>' + list2[i2].aiScore + ' 점</span>';
              html += '					</div>';
              html += '				</div>';
              html += '			</div>';
            }
            html += '		</div>';
            html += '	</div>';
            html += '</div>';
          } else {
            html += '</div>';
            html += '<div class="challenge_no">';
            html += '	  <i class="ico_empty"></i>';
            html += '		순위에 든 퍼포머가 없네요!<br>';
            html += '		챌린지에 참여하고 우승해 랭킹에 올라보세요.';
            html += '</div>';
          }
        }
        $('#challengeList').append(html);
        $('#searchChallengeForm #lastPage').val(result.data.lastPage);
        $('#searchChallengeForm #rowsPerPage').val('20');

        CRswiper = new Swiper('.ranking_slider', {
          freeMode: false,
          slidesPerView: 'auto',
          spaceBetween: 13,
          observer: true,
          on: {
            reachEnd: function () {},
            activeIndexChange: function () {
              var chlgNo = this.$el[0].dataset.chlgNo;
              var activeIndex = this.activeIndex;
              var realIndex = $('#swiper-wrapper-' + chlgNo).children().length;
              //슬라이드 중간쯤 active되면 다음페이지 가져오기
              if (activeIndex >= Number(realIndex) - 5) {
                getChallengerVideoList(chlgNo);
              }
            }
          }
        });
        dfd.resolve();
      });
      return dfd.promise();
    }

    //챌린저 비디오 가져오기
    function getChallengerVideoList(chlgNo) {
      if ($('#challengerForm_' + chlgNo + ' #nowPage').val() >= $('#challengerForm_' + chlgNo + ' #lastPage').val() || $('#swiper-wrapper-' + chlgNo).children().length >= maxVideoCnt) return;
      $('#challengerForm_' + chlgNo + ' #nowPage').val(Number($('#challengerForm_' + chlgNo + ' #nowPage').val()) + 1);

      var param = $('#challengerForm_' + chlgNo).serialize();
      get('/api/challenge/challengerVideoList', param).done(function (result) {
        var list = result.data.list;
        var html = '';
        for (var i = 0; i < list.length; i++) {
          var blind = '';
          var clickUseYn = '';
          var memberId = '@' + list[i].memberId;
          var divPerformer = '<div class="performer" onclick="viewUserProfile(\'' + list[i].regMemberNo + '\');" style="background-image:url(/as-is/rsc/front/images/common/ico_mypage.png);"></div>';
          if (list[i].delYn == 'Y' || list[i].videoViewYn == 'N') {
            blind = 'blind';
            clickUseYn = 'N';
          }
          if (list[i].memberStatusCd == 'M20' || list[i].memberStatusCd == 'M99') {
            //memberId = "@"+list[i].memberId;
            memberId = list[i].memberStatusCd == 'M20' ? '정지회원' : '탈퇴회원';
            divPerformer = '<div class="performer" onclick="javascript:void(0);" style="background-image: url(' + list[i].profileImgUrl + '), url(/as-is/rsc/front/images/common/ico_mypage.png);"></div>';
          }
          html += '<div class="challenger_list swiper-slide">';
          //html += '	<div class="performer" onclick="viewUserProfile(\''+list[i].regMemberNo+'\');" style="background-image: url('+list[i].profileImgUrl+'), url(/as-is/rsc/front/images/common/ico_mypage.png);"></div>';
          html += divPerformer;
          //html += '	<a href="javascript:playVideo(\''+list[i].videoNo+'\');" class="thumb">';
          html += "	<a href=\"javascript:playVideo('rankVideo', '" + list[i].videoNo + "', '" + $('#challengerForm_' + chlgNo + ' #rowsPerPage').val() + "', '" + $('#challengerForm_' + chlgNo + ' #nowPage').val() + "', '" + chlgNo + "', null, null, '" + clickUseYn + '\');" class="thumb ' + blind + '">';
          html += '		<img src="' + list[i].videoThumbUrl + '" alt="">';
          html += '	</a>';
          html += '	<div class="id">';
          html += '		<p onclick="viewUserProfile(\'' + list[i].regMemberNo + '\');">' + memberId + '</p>';
          html += '		<div class="point_area">';
          html += '			<span><i class="ico_shoe"></i>' + list[i].votingCnt + ' 표</span>';
          html += '			<span><i class="ico_ai"></i>' + list[i].aiScore + ' 점</span>';
          html += '		</div>';
          html += '	</div>';
          html += '</div>';
        }
        $('#swiper-wrapper-' + chlgNo).append(html);
        //$("#challengerForm_"+chlgNo+" #lastPage").val(result.data.lastPage);
      });
    }

    //searchWord 입력 시 clear button 노출
    $(document)
      .off('propertychange change keyup paste input', '#searchChallengeForm #searchWord')
      .on('propertychange change keyup paste input', '#searchChallengeForm #searchWord', function () {
        if ($(this).val().length > 0) {
          $('#searchChallengeForm .btn_clear').show();
        } else {
          $('#searchChallengeForm .btn_clear').hide();
        }
      });

    $(document)
      .off('click', '#searchChallengeForm .btn_clear')
      .on('click', '#searchChallengeForm .btn_clear', function () {
        $('#searchChallengeForm #searchWord').trigger('change');
      });
  </script>
  <!-- header -->
  <header>
    <button type="button" class="btn_go_prev" onclick="searchBack()">이전으로</button>
    <h1>챌린지</h1>
  </header>
  <!--// header -->

  <!-- contents -->
  <div class="contents">
    <form id="searchChallengeForm" onsubmit="return false">
      <input type="hidden" id="viewYn" name="viewYn" value="Y" />
      <input type="hidden" id="rowsPerPage" name="rowsPerPage" value="10" />
      <input type="hidden" id="nowPage" name="nowPage" value="1" />
      <input type="hidden" id="lastPage" name="lastPage" value="0" />
      <input type="hidden" id="searchType" name="searchType" value="chlgName" />
      <!-- <input type="hidden" id="searchWord" name="searchWord" value=""> -->
      <input type="hidden" id="sortField" name="sortField" value="CHLG_PTCP_VIDEO_CNT" />
      <input type="hidden" id="sortWord" name="sortWord" value="DESC" />
      <div class="search_form">
        <div class="input_wrap">
          <input type="search" class="clear" id="searchWord" name="searchWord" value="" placeholder="챌린지 검색..." maxlength="30" />
          <button class="btn_clear" onclick="clearInput(this)" style="display: none"></button>
        </div>
        <button type="button" class="btn_go_search" onclick="search()">검색</button>
      </div>
    </form>
    <div id="challengeList"></div>
  </div>
  <!--// contents -->
</div>
